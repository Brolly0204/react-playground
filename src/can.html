<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <style>
      @font-face {
        font-family: 'hanyi';
        src: url('./HanYiChangSongJian.ttf');
      }
    </style>
  </head>

  <body>
    <!-- 触发下载操作的按钮 -->
    <button onclick="download('#myCanvas')">下载</button>
    <h3 style="font: 500 18px hanyi">首都医科大学</h3>
    <canvas id="myCanvas" width="220" height="220"></canvas>
    <script>
      let mColor = 'rgb(255 25 33)'
      // let color = '#de000b'
      function download(selector) {
        // 通过 API 获取目标 canvas 元素
        const canvas = document.querySelector(selector)

        // 创建一个 a 标签，并设置 href 和 download 属性
        const el = document.createElement('a')
        // 设置 href 为图片经过 base64 编码后的字符串，默认为 png 格式
        el.href = canvas.toDataURL()
        el.download = '诊断章'

        // 创建一个点击事件并对 a 标签进行触发
        const event = new MouseEvent('click')
        el.dispatchEvent(event)
      }
      function createSeal(id, company, name) {
        var canvas = document.getElementById(id)
        var context = canvas.getContext('2d')

        // 绘制印章边框
        // var width = canvas.width / 2;
        // var height = canvas.height / 2;
        var width = canvas.width / 2
        var height = canvas.height / 2
        context.lineWidth = 4
        // context.strokeStyle = mColor
        context.strokeStyle = 'rgba(255, 0, 0, 0.8)'

        context.beginPath()
        context.arc(width, height, 98, 0, Math.PI * 2)
        context.stroke()
        //画五角星
        create5star(context, width, height, 35, 'rgba(255, 25, 33, .8)', 0)

        // 绘制印章名称
        context.font = '200 22px hanyi'
        context.textBaseline = 'middle' //设置文本的垂直对齐方式
        context.textAlign = 'center' //设置文本的水平对对齐方式
        context.lineWidth = 1
        context.fillStyle = 'rgba(255, 25, 33, .88)'
        // context.fillText(name, width, height + 50);
        let x = width / 2 - 12
        for (let char of name) {
          context.fillText(char, x, height + 47)
          x += 17
        }
        // 绘制印章名称2
        context.font = '300 16px hanyi'
        context.textBaseline = 'middle' //设置文本的垂直对齐方式
        context.textAlign = 'center' //设置文本的水平对对齐方式
        context.lineWidth = 1
        context.fillStyle = 'rgba(255, 25, 33, .9)'
        
        context.fillText('(3)', width, height + 69)

        // 绘制印章单位
        context.translate(width, height) // 平移到此位置,
        context.font = '300 25px hanyi'
        
        context.fillStyle = 'rgba(255, 25, 33, .7)'
        var count = company.length // 字数
        var angle = (4.1 * Math.PI) / (3.5 * (count - 1)) // 字间角度
        var chars = company.split('')
        var c
        for (var i = 0; i < count; i++) {
          c = chars[i] // 需要绘制的字符
          if (i == 0) context.rotate((5.49 * Math.PI) / 6)
          else context.rotate(angle)
          context.save()
          context.translate(90, 0) // 平移到此位置,此时字和x轴垂直
          context.rotate(Math.PI / 2) // 旋转90度,让字平行于x轴
          context.fillText(c, 0, 11) // 此点为字的中心点
          context.restore()
        }

        let num = '1101020391040'.split('').reverse().join('')
        context.translate(0, -9) // 平移到此位置,
        context.font = '400 12px hanyi'
        context.fillStyle = 'rgba(255, 0, 0, 1)'
        var count = num.length // 字数
        var angle = (2.8 * Math.PI) / (8 * (count - 1)) // 字间角度
        var chars = num.split('')
        var c
        for (var i = 0; i < count; i++) {
          c = chars[i] // 需要绘制的字符
          if (i == 0) context.rotate((16.3 * Math.PI) / count)
          else context.rotate(angle)
          context.save()
          context.translate(-90, 0) // 平移到此位置,此时字和x轴垂直
          context.rotate(Math.PI / 2) // 旋转90度,让字平行于x轴
          context.fillText(c, 0, 5) // 此点为字的中心点
          context.restore()
        }

        context.beginPath()

        //绘制五角星
        /**
         * 创建一个五角星形状. 该五角星的中心坐标为(sx,sy),中心到顶点的距离为radius,rotate=0时一个顶点在对称轴上
         * rotate:绕对称轴旋转rotate弧度
         */
        function create5star(context, sx, sy, radius, color, rotato) {
          context.save()
          context.translate(sx, sy) //移动坐标原点
          context.rotate(Math.PI + rotato) //旋转
          context.beginPath() //创建路径
          var x = Math.sin(0)
          var y = Math.cos(0)
          var dig = (Math.PI / 5) * 4
          for (var i = 0; i < 5; i++) {
            //画五角星的五条边
            var x = Math.sin(i * dig)
            var y = Math.cos(i * dig)
            context.lineTo(x * radius, y * radius)
          }
          context.closePath()
          // context.strokeStyle = 'rgba(255, 0, 0, 0.5)'; // 半透明红色
          // context.stroke()
          context.fillStyle = 'rgba(255, 0, 0, 0.7)'
          context.fill()
          context.restore()

        }
      }
      document.fonts.load('24px hanyi').then(() => {
        // 利用canvas绘制图形
        createSeal(
          'myCanvas',
          '首都医科大学附属北京安定医院',
          '门诊诊断证明专用章'
        )
            var canvas = document.getElementById('myCanvas')
            var ctx = canvas.getContext('2d')
            ctx.translate(-canvas.width/2, -canvas.height/2)
            ctx.rotate(0)

        // 老化效果 - 随机斑点
        blur(canvas, ctx)

      })

      function blur(canvas, ctx) {
        for (let i = 0; i < 1200; i++) {
          ctx.beginPath()
          ctx.arc(
            Math.random() * canvas.width,
            Math.random() * canvas.height,
            Math.random() * 1.1,
            0,
            2 * Math.PI
          )
          // ctx.fillStyle = 'rgba(128, 128, 128, 0.5)';
          ctx.fillStyle = '#fff'
          // ctx.fillStyle = 'black'
          ctx.fill()
        }
      }
    </script>
  </body>
</html>
